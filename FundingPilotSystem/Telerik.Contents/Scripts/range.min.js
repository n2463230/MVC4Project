function documentFromRange(n){var t=n.startContainer;return t.nodeType==9?t:t.ownerDocument}function selectionFromWindow(n){return $.browser.msie&&$.browser.version<9?new W3CSelection(n.document):n.getSelection()}function selectionFromRange(n){var t=documentFromRange(n);return selectionFromDocument(t)}function selectionFromDocument(n){return selectionFromWindow(windowFromDocument(n))}function windowFromDocument(n){return n.defaultView||n.parentWindow}function split(n,t,i){function r(r){var f=n.cloneRange(),u;f.collapse(r),f[r?"setStartBefore":"setEndAfter"](t),u=f.extractContents(),i&&(u=dom.trim(u)),dom[r?"insertBefore":"insertAfter"](u,t)}r(!0),r(!1)}function selectRange(n){var t=RangeUtils.image(n),i;t&&(n.setStartAfter(t),n.setEndAfter(t)),i=selectionFromRange(n),i.removeAllRanges(),i.addRange(n)}function W3CRange(n){$.extend(this,{ownerDocument:n,startContainer:n,endContainer:n,commonAncestorContainer:n,startOffset:0,endOffset:0,collapsed:!0})}function compareBoundaries(n,t,i,r){var u,o,f,e;if(n==t)return r-i;for(u=t;u&&u.parentNode!=n;)u=u.parentNode;if(u)return findNodeIndex(u)-i;for(u=n;u&&u.parentNode!=t;)u=u.parentNode;if(u)return r-findNodeIndex(u)-1;for(o=dom.commonAncestor(n,t),f=n;f&&f.parentNode!=o;)f=f.parentNode;for(f||(f=o),e=t;e&&e.parentNode!=o;)e=e.parentNode;return(e||(e=o),f==e)?0:findNodeIndex(e)-findNodeIndex(f)}function fixIvalidRange(n,t){function i(n){try{return compareBoundaries(n.startContainer,n.endContainer,n.startOffset,n.endOffset)<0}catch(t){return!0}}i(n)&&(t?(n.commonAncestorContainer=n.endContainer=n.startContainer,n.endOffset=n.startOffset):(n.commonAncestorContainer=n.startContainer=n.endContainer,n.startOffset=n.endOffset),n.collapsed=!0)}function updateRangeProperties(n){n.collapsed=n.startContainer==n.endContainer&&n.startOffset==n.endOffset;for(var t=n.startContainer;t&&t!=n.endContainer&&!isAncestorOf(t,n.endContainer);)t=t.parentNode;n.commonAncestorContainer=t}function createRange(n){return $.browser.msie&&$.browser.version<9?new W3CRange(n):n.createRange()}function RangeIterator(n){if($.extend(this,{range:n,_current:null,_next:null,_end:null}),!n.collapsed){var t=n.commonAncestorContainer;this._next=n.startContainer==t&&!isDataNode(n.startContainer)?n.startContainer.childNodes[n.startOffset]:findClosestAncestor(t,n.startContainer),this._end=n.endContainer==t&&!isDataNode(n.endContainer)?n.endContainer.childNodes[n.endOffset]:findClosestAncestor(t,n.endContainer).nextSibling}}function W3CSelection(n){this.ownerDocument=n,this.rangeCount=1}function adoptContainer(n,t,i){var r=t[i?"startContainer":"endContainer"],e=t[i?"startOffset":"endOffset"],o=0,s=isDataNode(r)?r:r.childNodes[e]||null,h=isDataNode(r)?r.parentNode:r,f,u;(r.nodeType==3||r.nodeType==4)&&(o=e),f=h.insertBefore(dom.create(t.ownerDocument,"a"),s),u=t.ownerDocument.body.createTextRange(),u.moveToElementText(f),dom.remove(f),u[i?"moveStart":"moveEnd"]("character",o),u.collapse(!1),n.setEndPoint(i?"StartToStart":"EndToStart",u)}function adoptEndPoint(n,t,i){var u=dom.create(t.ownerDocument,"a"),f=n.duplicate(),e,r;f.collapse(i),e=f.parentElement();do e.insertBefore(u,u.previousSibling),f.moveToElementText(u);while(f.compareEndPoints(i?"StartToStart":"StartToEnd",n)>0&&u.previousSibling);if(f.setEndPoint(i?"EndToStart":"EndToEnd",n),r=u.nextSibling,!r){r=u.previousSibling,r&&isDataNode(r)?(t.setEnd(r,r.nodeValue.length),dom.remove(u)):(t.selectNodeContents(e),dom.remove(u),t.endOffset-=1);return}dom.remove(u),isDataNode(r)?t[i?"setStart":"setEnd"](r,f.text.length):t[i?"setStartBefore":"setEndBefore"](r)}function RangeEnumerator(n){this.enumerate=function(){function i(n){if(dom.is(n,"img")||n.nodeType==3&&!dom.isWhitespace(n))t.push(n);else for(n=n.firstChild;n;)i(n),n=n.nextSibling}var t=[];return new RangeIterator(n).traverse(i),t}}function textNodes(n){return new RangeEnumerator(n).enumerate()}function blockParents(n){for(var r=[],i,t=0,u=n.length;t<u;t++)i=dom.parentOfType(n[t],blockElements),i&&$.inArray(i,r)<0&&r.push(i);return r}function getMarkers(n){var t=[];return new RangeIterator(n).traverse(function(n){n.className=="t-marker"&&t.push(n)}),t}function RestorePoint(n){function f(n){for(var i=0,r=n.nodeType,t;n=n.previousSibling;)t=n.nodeType,(t!=3||r!=t)&&i++,r=t;return i}function i(n,t){if(n.nodeType==3)while((n=n.previousSibling)&&n.nodeType==3)t+=n.nodeValue.length;return t}function r(n){for(var i=[];n!=t;)i.push(f(n)),n=n.parentNode;return i}function u(n,i,r,u){for(var f=t,o=r.length,e=u;o--;)f=f.childNodes[r[o]];while(f.nodeType==3&&f.nodeValue.length<e)e-=f.nodeValue.length,f=f.nextSibling;n[i?"setStart":"setEnd"](f,e)}var t=documentFromRange(n);this.body=t.body,this.html=this.body.innerHTML,this.startContainer=r(n.startContainer),this.endContainer=r(n.endContainer),this.startOffset=i(n.startContainer,n.startOffset),this.endOffset=i(n.endContainer,n.endOffset),this.toRange=function(){var t=n.cloneRange();return u(t,!0,this.startContainer,this.startOffset),u(t,!1,this.endContainer,this.endOffset),t}}function Marker(){var n;this.addCaret=function(t){return n=dom.create(documentFromRange(t),"span",{className:"t-marker"}),t.insertNode(n),t.selectNode(n),n},this.removeCaret=function(t){var i=n.previousSibling,e=0,r,o,u,f;i&&(e=isDataNode(i)?i.nodeValue.length:findNodeIndex(i)),r=n.parentNode,o=i?findNodeIndex(i):0,dom.remove(n),normalize(r),u=r.childNodes[o],isDataNode(u)?t.setStart(u,e):u?(f=dom.lastTextNode(u),f?t.setStart(f,f.nodeValue.length):t[i?"setStartAfter":"setStartBefore"](u)):($.browser.msie||r.innerHTML!=""||(r.innerHTML='<br _moz_dirty="" />'),t.selectNodeContents(r)),t.collapse(!0)},this.add=function(n,t){t&&n.collapsed&&(this.addCaret(n),n=RangeUtils.expand(n));var i=n.cloneRange();return i.collapse(!1),this.end=dom.create(documentFromRange(n),"span",{className:"t-marker"}),i.insertNode(this.end),i=n.cloneRange(),i.collapse(!0),this.start=this.end.cloneNode(!0),i.insertNode(this.start),n.setStartBefore(this.start),n.setEndAfter(this.end),normalize(n.commonAncestorContainer),n},this.remove=function(t){var i=this.start,r=this.end,y,p,e,s,o,h,u,f;for(normalize(t.commonAncestorContainer);!i.nextSibling&&i.parentNode;)i=i.parentNode;while(!r.previousSibling&&r.parentNode)r=r.parentNode;if(y=i.previousSibling&&i.previousSibling.nodeType==3&&i.nextSibling&&i.nextSibling.nodeType==3,p=r.previousSibling&&r.previousSibling.nodeType==3&&r.nextSibling&&r.nextSibling.nodeType==3,i=i.nextSibling,r=r.previousSibling,e=!1,s=!1,i==this.end&&(s=!!this.start.previousSibling,i=r=this.start.previousSibling||this.end.nextSibling,e=!0),dom.remove(this.start),dom.remove(this.end),i==null||r==null){t.selectNodeContents(t.commonAncestorContainer),t.collapse(!0);return}if(o=e?isDataNode(i)?i.nodeValue.length:i.childNodes.length:0,h=isDataNode(r)?r.nodeValue.length:r.childNodes.length,i.nodeType==3)while(i.previousSibling&&i.previousSibling.nodeType==3)i=i.previousSibling,o+=i.nodeValue.length;if(r.nodeType==3)while(r.previousSibling&&r.previousSibling.nodeType==3)r=r.previousSibling,h+=r.nodeValue.length;var c=findNodeIndex(i),l=i.parentNode,a=findNodeIndex(r),v=r.parentNode;for(u=i;u.previousSibling;u=u.previousSibling)u.nodeType==3&&u.previousSibling.nodeType==3&&c--;for(f=r;f.previousSibling;f=f.previousSibling)f.nodeType==3&&f.previousSibling.nodeType==3&&a--;normalize(l),i.nodeType==3&&(i=l.childNodes[c]),normalize(v),r.nodeType==3&&(r=v.childNodes[a]),e?(i.nodeType==3?t.setStart(i,o):t[s?"setStartAfter":"setStartBefore"](i),t.collapse(!0)):(i.nodeType==3?t.setStart(i,o):t.setStartBefore(i),r.nodeType==3?t.setEnd(r,h):t.setEndAfter(r)),n&&this.removeCaret(t)}}var START_TO_START=0,START_TO_END=1,END_TO_END=2,END_TO_START=3,boundary,RangeUtils;W3CRange.prototype={setStart:function(n,t){this.startContainer=n,this.startOffset=t,updateRangeProperties(this),fixIvalidRange(this,!0)},setEnd:function(n,t){this.endContainer=n,this.endOffset=t,updateRangeProperties(this),fixIvalidRange(this,!1)},setStartBefore:function(n){this.setStart(n.parentNode,findNodeIndex(n))},setStartAfter:function(n){this.setStart(n.parentNode,findNodeIndex(n)+1)},setEndBefore:function(n){this.setEnd(n.parentNode,findNodeIndex(n))},setEndAfter:function(n){this.setEnd(n.parentNode,findNodeIndex(n)+1)},selectNode:function(n){this.setStartBefore(n),this.setEndAfter(n)},selectNodeContents:function(n){this.setStart(n,0),this.setEnd(n,n[n.nodeType===1?"childNodes":"nodeValue"].length)},collapse:function(n){n?this.setEnd(this.startContainer,this.startOffset):this.setStart(this.endContainer,this.endOffset)},deleteContents:function(){var n=this.cloneRange();this.startContainer!=this.commonAncestorContainer&&this.setStartAfter(findClosestAncestor(this.commonAncestorContainer,this.startContainer)),this.collapse(!0),function t(n){while(n.next())n.hasPartialSubtree()?t(n.getSubtreeIterator()):n.remove()}(new RangeIterator(n))},cloneContents:function(){var n=documentFromRange(this);return function t(i){for(var r,u=n.createDocumentFragment();r=i.next();)r=r.cloneNode(!i.hasPartialSubtree()),i.hasPartialSubtree()&&r.appendChild(t(i.getSubtreeIterator())),u.appendChild(r);return u}(new RangeIterator(this))},extractContents:function(){var i=this.cloneRange(),n,t;return this.startContainer!=this.commonAncestorContainer&&this.setStartAfter(findClosestAncestor(this.commonAncestorContainer,this.startContainer)),this.collapse(!0),n=this,t=documentFromRange(this),function r(i){for(var u,f=t.createDocumentFragment();u=i.next();)i.hasPartialSubtree()?u=u.cloneNode(!1):i.remove(n.originalRange),i.hasPartialSubtree()&&u.appendChild(r(i.getSubtreeIterator())),f.appendChild(u);return f}(new RangeIterator(i))},insertNode:function(n){isDataNode(this.startContainer)?(this.startOffset!=this.startContainer.nodeValue.length&&splitDataNode(this.startContainer,this.startOffset),dom.insertAfter(n,this.startContainer)):dom.insertAt(this.startContainer,n,this.startOffset),this.setStart(this.startContainer,this.startOffset)},cloneRange:function(){return $.extend(new W3CRange(this.ownerDocument),{startContainer:this.startContainer,endContainer:this.endContainer,commonAncestorContainer:this.commonAncestorContainer,startOffset:this.startOffset,endOffset:this.endOffset,collapsed:this.collapsed,originalRange:this})},toString:function(){var n=this.startContainer.nodeName,t=this.endContainer.nodeName;return[n=="#text"?this.startContainer.nodeValue:n,"(",this.startOffset,") : ",t=="#text"?this.endContainer.nodeValue:t,"(",this.endOffset,")"].join("")}},RangeIterator.prototype={hasNext:function(){return!!this._next},next:function(){var n=this._current=this._next;return this._next=this._current&&this._current.nextSibling!=this._end?this._current.nextSibling:null,isDataNode(this._current)&&(this.range.endContainer==this._current&&(n=n.cloneNode(!0)).deleteData(this.range.endOffset,n.length-this.range.endOffset),this.range.startContainer==this._current&&(n=n.cloneNode(!0)).deleteData(0,this.range.startOffset)),n},traverse:function(n){function i(){return this._current=this._next,this._next=this._current&&this._current.nextSibling!=this._end?this._current.nextSibling:null,this._current}for(var t;t=i.call(this);)this.hasPartialSubtree()?this.getSubtreeIterator().traverse(n):n(t);return t},remove:function(n){var i=this.range.startContainer==this._current,r=this.range.endContainer==this._current,t,e;if(isDataNode(this._current)&&(i||r)){var u=i?this.range.startOffset:0,o=r?this.range.endOffset:this._current.length,f=o-u;n&&(i||r)&&(this._current==n.startContainer&&u<=n.startOffset&&(n.startOffset-=f),this._current==n.endContainer&&o<=n.endOffset&&(n.endOffset-=f)),this._current.deleteData(u,f)}else t=this._current.parentNode,n&&(this.range.startContainer==t||this.range.endContainer==t)&&(e=findNodeIndex(this._current),t==n.startContainer&&e<=n.startOffset&&(n.startOffset-=1),t==n.endContainer&&e<n.endOffset&&(n.endOffset-=1)),dom.remove(this._current)},hasPartialSubtree:function(){return!isDataNode(this._current)&&(isAncestorOrSelf(this._current,this.range.startContainer)||isAncestorOrSelf(this._current,this.range.endContainer))},getSubtreeIterator:function(){var n=this.range.cloneRange();return n.selectNodeContents(this._current),isAncestorOrSelf(this._current,this.range.startContainer)&&n.setStart(this.range.startContainer,this.range.startOffset),isAncestorOrSelf(this._current,this.range.endContainer)&&n.setEnd(this.range.endContainer,this.range.endOffset),new RangeIterator(n)}},W3CSelection.prototype={addRange:function(n){var t=this.ownerDocument.body.createTextRange();adoptContainer(t,n,!1),adoptContainer(t,n,!0),t.select()},removeAllRanges:function(){this.ownerDocument.selection.empty()},getRangeAt:function(){var r,n=new W3CRange(this.ownerDocument),o=this.ownerDocument.selection,s,f,e;try{if(r=o.createRange(),s=r.item?r.item(0):r.parentElement(),s.ownerDocument!=this.ownerDocument)return n}catch(h){return n}if(o.type=="Control")n.selectNode(r.item(0));else{adoptEndPoint(r,n,!0),adoptEndPoint(r,n,!1),n.startContainer.nodeType==9&&n.setStart(n.endContainer,n.startOffset),n.endContainer.nodeType==9&&n.setEnd(n.startContainer,n.endOffset),r.compareEndPoints("StartToEnd",r)==0&&n.collapse(!1);var t=n.startContainer,i=n.endContainer,u=this.ownerDocument.body;if(!n.collapsed&&n.startOffset==0&&n.endOffset==getNodeLength(n.endContainer)&&!(t==i&&isDataNode(t)&&t.parentNode==u)){for(f=!1,e=!1;findNodeIndex(t)==0&&t==t.parentNode.firstChild&&t!=u;)t=t.parentNode,f=!0;while(findNodeIndex(i)==getNodeLength(i.parentNode)-1&&i==i.parentNode.lastChild&&i!=u)i=i.parentNode,e=!0;t==u&&i==u&&f&&e&&(n.setStart(t,0),n.setEnd(i,getNodeLength(u)))}}return n}},boundary=/[\u0009-\u000d]|\u0020|\u00a0|\ufeff|\.|,|;|:|!|\(|\)|\?/,RangeUtils={nodes:function(n){var t=textNodes(n);return t.length||(n.selectNodeContents(n.commonAncestorContainer),t=textNodes(n),t.length||(t=dom.significantChildNodes(n.commonAncestorContainer))),t},image:function(n){var t=[];return new RangeIterator(n).traverse(function(n){dom.is(n,"img")&&t.push(n)}),t.length==1?t[0]:void 0},expand:function(n){var t=n.cloneRange(),e=t.startContainer.childNodes[t.startOffset==0?0:t.startOffset-1],o=t.endContainer.childNodes[t.endOffset],u,f,i,r;return!isDataNode(e)||!isDataNode(o)?t:(u=e.nodeValue,f=o.nodeValue,u==""||f=="")?t:(i=u.split("").reverse().join("").search(boundary),r=f.search(boundary),i==0||r==0)?t:(r=r==-1?f.length:r,i=i==-1?0:u.length-i,t.setStart(e,i),t.setEnd(o,r),t)},isExpandable:function(n){var i=n.startContainer,u=documentFromRange(n),r,t;if(i==u||i==u.body||(r=n.cloneRange(),t=i.nodeValue,!t))return!1;var f=t.substring(0,r.startOffset),e=t.substring(r.startOffset),o=0,s=0;return f!=""&&(o=f.split("").reverse().join("").search(boundary)),e!=""&&(s=e.search(boundary)),o!=0&&s!=0}};