function Command(n){var t=new RestorePoint(n.range),i=new Marker;this.formatter=n.formatter,this.getRange=function(){return t.toRange()},this.lockRange=function(n){return i.add(this.getRange(),n)},this.releaseRange=function(n){i.remove(n),selectRange(n)},this.undo=function(){t.body.innerHTML=t.html,selectRange(t.toRange())},this.redo=function(){this.exec()},this.exec=function(){var n=this.lockRange(!0);this.formatter.editor=this.editor,this.formatter.toggle(n),this.releaseRange(n)}}function GenericCommand(n,t){var i=n.body;this.redo=function(){i.innerHTML=t.html,selectRange(t.toRange())},this.undo=function(){i.innerHTML=n.html,selectRange(n.toRange())}}function InsertHtmlCommand(n){Command.call(this,n),this.managesUndoRedo=!0,this.exec=function(){var t=this.editor,i=t.getRange(),r=new RestorePoint(i);t.clipboard.paste(n.value||""),t.undoRedoStack.push(new GenericCommand(r,new RestorePoint(t.getRange()))),t.focus()}}function InsertHtmlTool(){Tool.call(this),this.command=function(n){return new InsertHtmlCommand(n)},this.update=function(n){n.data("tSelectBox").close()},this.init=function(n,t){var i=t.editor;n.tSelectBox({data:i.insertHtml,onItemCreate:function(n){n.html='<span unselectable="on">'+n.dataItem.Text+"<\/span>"},onChange:function(n){Tool.exec(i,"insertHtml",n.value)},highlightFirst:!1}).find(".t-input").html(i.localization.insertHtml)}}function UndoRedoStack(){var n=[],t=-1;this.push=function(i){n=n.slice(0,t+1),t=n.push(i)-1},this.undo=function(){this.canUndo()&&n[t--].undo()},this.redo=function(){this.canRedo()&&n[++t].redo()},this.canUndo=function(){return t>=0},this.canRedo=function(){return t!=n.length-1}}function TypingHandler(n){this.keydown=function(t){var i=n.keyboard,u=i.isTypingKey(t),r;return u&&!i.typingInProgress()?(r=n.getRange(),this.startRestorePoint=new RestorePoint(r),i.startTyping($.proxy(function(){n.selectionRestorePoint=this.endRestorePoint=new RestorePoint(n.getRange()),n.undoRedoStack.push(new GenericCommand(this.startRestorePoint,this.endRestorePoint))},this)),!0):!1},this.keyup=function(){var t=n.keyboard;return t.typingInProgress()?(t.endTyping(),!0):!1}}function SystemHandler(n){var t=!1;this.createUndoCommand=function(){this.endRestorePoint=new RestorePoint(n.getRange()),n.undoRedoStack.push(new GenericCommand(this.startRestorePoint,this.endRestorePoint)),this.startRestorePoint=this.endRestorePoint},this.changed=function(){return this.startRestorePoint?this.startRestorePoint.html!=n.body.innerHTML:!1},this.keydown=function(i){var r=n.keyboard;return r.isModifierKey(i)?(r.typingInProgress()&&r.endTyping(!0),this.startRestorePoint=new RestorePoint(n.getRange()),!0):r.isSystem(i)?(t=!0,this.changed()&&(t=!1,this.createUndoCommand()),!0):!1},this.keyup=function(n){return t&&this.changed()?(t=!1,this.createUndoCommand(n),!0):!1}}function Keyboard(n){function e(n){return n>=48&&n<=90||n>=96&&n<=111||n>=186&&n<=192||n>=219&&n<=222}function u(){t=!1,i&&i()}function f(t,i){for(var r=0;r<n.length;r++)if(n[r][i](t))break}var t=!1,r,i;this.toolFromShortcut=function(n,t){var u=String.fromCharCode(t.keyCode),r,i;for(r in n)if(i=n[r],(i.key==u||i.key==t.keyCode)&&!!i.ctrl==t.ctrlKey&&!!i.alt==t.altKey&&!!i.shift==t.shiftKey)return r},this.isTypingKey=function(n){var t=n.keyCode;return e(t)&&!n.ctrlKey&&!n.altKey||t==32||t==13||t==8||t==46&&!n.shiftKey&&!n.ctrlKey&&!n.altKey},this.isModifierKey=function(n){var t=n.keyCode;return t==17&&!n.shiftKey&&!n.altKey||t==16&&!n.ctrlKey&&!n.altKey||t==18&&!n.ctrlKey&&!n.shiftKey},this.isSystem=function(n){return n.keyCode==46&&n.ctrlKey&&!n.altKey&&!n.shiftKey},this.startTyping=function(n){i=n,t=!0},this.endTyping=function(n){this.clearTimeout(),n?u():r=window.setTimeout(u,1e3)},this.typingInProgress=function(){return t},this.clearTimeout=function(){window.clearTimeout(r)},this.keydown=function(n){f(n,"keydown")},this.keyup=function(n){f(n,"keyup")}}function Clipboard(n){function i(t){var i=dom.create(n.document,"div"),r;for(i.innerHTML=t,r=n.document.createDocumentFragment();i.firstChild;)r.appendChild(i.firstChild);return r}function u(n){return/<(div|p|ul|ol|table|h[1-6])/i.test(n)}function r(n,t){if(n)return dom.parentOfType(t,["p","ul","ol"])||t.parentNode;var i=t.parentNode,r=t.ownerDocument.body;if(dom.isInline(i))while(i.parentNode!=r&&!dom.isBlock(i.parentNode))i=i.parentNode;return i}var t=[new MSWordFormatCleaner];this.oncut=function(){var t=new RestorePoint(n.getRange());setTimeout(function(){n.undoRedoStack.push(new GenericCommand(t,new RestorePoint(n.getRange())))})},this.onpaste=function(t){var e=n.getRange(),o=new RestorePoint(e),i=dom.create(n.document,"div",{className:"t-paste-container",innerHTML:"﻿"}),r,u,f;n.body.appendChild(i),n.body.createTextRange?(t.preventDefault(),r=n.createRange(),r.selectNodeContents(i),n.selectRange(r),u=n.body.createTextRange(),u.moveToElementText(i),$(n.body).unbind("paste"),u.execCommand("Paste"),$(n.body).bind("paste",arguments.callee)):(f=n.createRange(),f.selectNodeContents(i),selectRange(f)),setTimeout(function(){selectRange(e),dom.remove(i),i.lastChild&&dom.is(i.lastChild,"br")&&dom.remove(i.lastChild);var t={html:i.innerHTML};$t.trigger(n.element,"paste",t),n.clipboard.paste(t.html,!0),n.undoRedoStack.push(new GenericCommand(o,new RestorePoint(n.getRange()))),selectionChanged(n)})},this.paste=function(f,e){for(var v,o,c,y,s=0,a=t.length;s<a;s++)t[s].applicable(f)&&(f=t[s].clean(f));e&&(f=f.replace(/(<br>(\s|&nbsp;)*)+(<\/?(div|p|li|col|t))/ig,"$3"),f=f.replace(/<(a|span)[^>]*><\/\1>/ig,"")),f=f.replace(/^<li/i,"<ul><li").replace(/li>$/g,"li><\/ul>"),v=u(f),o=n.getRange(),o.deleteContents(),o.startContainer==n.document&&o.selectNodeContents(n.body);var p=new Marker,h=p.addCaret(o),l=r(v,h),w=!1;if(!/body|td/.test(dom.name(l))&&(v||dom.isInline(l))&&(o.selectNode(h),split(o,l,!0),w=!0),c=i(f),c.firstChild&&c.firstChild.className==="t-paste-container"){for(y=[],s=0,a=c.childNodes.length;s<a;s++)y.push(c.childNodes[s].innerHTML);c=i(y.join("<br />"))}if(o.insertNode(c),l=r(v,h),w){while(h.parentNode!=l)dom.unwrap(h.parentNode);dom.unwrap(h.parentNode)}normalize(o.commonAncestorContainer),h.style.display="inline",dom.scrollTo(h),p.removeCaret(o),selectRange(o)}}function MSWordFormatCleaner(){function t(n){return/^[\u2022\u00b7\u00a7\u00d8o]\u00a0+/.test(n)?"ul":/^\s*\w+[\.\)]\u00a0{2,}/.test(n)?"ol":void 0}function i(n){for(var e=dom.create(document,"div",{innerHTML:n}),v=$(blockElements.join(","),e),l=-1,y,u={ul:{},ol:{}},o=e,s,r,c,a,h=0;h<v.length;h++){var i=v[h],n=i.innerHTML.replace(/<\/?\w+[^>]*>/g,"").replace(/&nbsp;/g," "),f=t(n);if(!f||dom.name(i)!="p"){i.innerHTML==""?dom.remove(i):(u={ul:{},ol:{}},o=e,l=-1);continue}if(s=parseFloat(i.style.marginLeft||0),r=u[f][s],(s>l||!r)&&(r=dom.create(document,f),o==e?dom.insertBefore(r,i):o.appendChild(r),u[f][s]=r),y!=f)for(c in u)for(a in u[c])$.contains(r,u[c][a])&&delete u[c][a];dom.remove(i.firstChild),o=dom.create(document,"li",{innerHTML:i.innerHTML}),r.appendChild(o),dom.remove(i),l=s,y=f}return e.innerHTML}function r(n){return n.replace(/<a([^>]*)>\s*<\/a>/ig,function(n,t){return!t||t.indexOf("href")<0?"":n})}var n=[/<!--(.|\n)*?-->/g,"",/&quot;/g,"'",/(?:<br>&nbsp;[\s\r\n]+|<br>)*(<\/?(h[1-6]|hr|p|div|table|tbody|thead|tfoot|th|tr|td|li|ol|ul|caption|address|pre|form|blockquote|dl|dt|dd|dir|fieldset)[^>]*>)(?:<br>&nbsp;[\s\r\n]+|<br>)*/g,"$1",/<br><br>/g,"<BR><BR>",/<br>/g," ",/<BR><BR>/g,"<br>",/^\s*(&nbsp;)+/gi,"",/(&nbsp;|<br[^>]*>)+\s*$/gi,"",/mso-[^;"]*;?/ig,"",/<(\/?)b(\s[^>]*)?>/ig,"<$1strong$2>",/<(\/?)i(\s[^>]*)?>/ig,"<$1em$2>",/<\/?(meta|link|style|o:|v:)[^>]*>((?:.|\n)*?<\/(meta|link|style|o:|v:)[^>]*>)?/ig,"",/style=(["|'])\s*\1/g,""];this.applicable=function(n){return/class="?Mso|style="[^"]*mso-/i.test(n)},this.clean=function(t){for(var u=0,f=n.length;u<f;u+=2)t=t.replace(n[u],n[u+1]);return t=r(t),t=i(t),t.replace(/\s+class="?[^"\s>]*"?/ig,"")}}