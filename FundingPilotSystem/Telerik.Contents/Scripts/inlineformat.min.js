function InlineFormatFinder(n){function t(n){for(var r=0,u=0,f=0,i=n.parentNode,t=i.firstChild;t;t=t.nextSibling)t!=n&&(t.className=="t-marker"?f++:t.nodeType==3?r++:u++);return f>1&&i.firstChild.className=="t-marker"&&i.lastChild.className=="t-marker"?0:u+r}this.findSuitable=function(i,r){return!r&&t(i)>0?null:dom.parentOfType(i,n[0].tags)},this.findFormat=function(t){for(var r=0;r<n.length;r++){var i=t,u=n[r].tags,f=n[r].attr;if(i&&dom.ofType(i,u)&&attrEquals(i,f))return i;while(i)if(i=dom.parentOfType(i,u),i&&attrEquals(i,f))return i}return null},this.isFormatted=function(n){for(var t=0;t<n.length;t++)if(this.findFormat(n[t]))return!0;return!1}}function InlineFormatter(n,t){function u(n){return dom.wrap(n,dom.create(n.ownerDocument,r,i))}this.finder=new InlineFormatFinder(n);var i=$.extend({},n[0].attr,t),r=n[0].tags[0];this.activate=function(n,t){this.finder.isFormatted(t)?(this.split(n),this.remove(t)):this.apply(t)},this.toggle=function(n){var t=textNodes(n);t.length>0&&this.activate(n,t)},this.apply=function(n){for(var e=[],f,t,r=0,o=n.length;r<o;r++)f=n[r],t=this.finder.findSuitable(f),t?dom.attr(t,i):t=u(f),e.push(t);this.consolidate(e)},this.remove=function(n){for(var t,r=0,u=n.length;r<u;r++)t=this.finder.findFormat(n[r]),t&&(i&&i.style?(dom.unstyle(t,i.style),t.style.cssText||dom.unwrap(t)):dom.unwrap(t))},this.split=function(n){var i=textNodes(n),t,u,r;if(i.length>0)for(t=0,u=i.length;t<u;t++)r=this.finder.findFormat(i[t]),r&&split(n,r,!0)},this.consolidate=function(n){while(n.length>1){var t=n.pop(),i=n[n.length-1];if(t.previousSibling&&t.previousSibling.className=="t-marker"&&i.appendChild(t.previousSibling),t.tagName==i.tagName&&t.previousSibling==i&&t.style.cssText==i.style.cssText){while(t.firstChild)i.appendChild(t.firstChild);dom.remove(t)}}}}function GreedyInlineFormatFinder(n,t){function r(n){var u=n.attributes,f=$.trim,i,h,o,r,c,s;if(u){for(i=0,h=u.length;i<h;i++){var e=u[i],y=e.nodeName,p=e.nodeValue;if(e.specified&&y=="style")for(o=f(p||n.style.cssText).split(";"),r=0,c=o.length;r<c;r++)if(s=o[r],s.length){var l=s.split(":"),a=f(l[0].toLowerCase()),v=f(l[1]);if(a!=t)continue;return a.indexOf("color")>=0?dom.toHex(v):v}}return}}function i(n){for(var o=$(isDataNode(n)?n.parentNode:n),u=o.parents().andSelf(),f,i=0,e=u.length;i<e;i++)if(f=t=="className"?u[i].className:r(u[i]),f)return f;return"inherit"}InlineFormatFinder.call(this,n),this.getFormat=function(n){for(var r=i(n[0]),t=1,u=n.length;t<u;t++)if(r!=i(n[t]))return"";return r},this.isFormatted=function(n){return this.getFormat(n)!==""}}function GreedyInlineFormatter(n,t,i){InlineFormatter.call(this,n,t),this.finder=new GreedyInlineFormatFinder(n,i),this.activate=function(n,r){if(this.split(n),i){var u=i.replace(/-([a-z])/,function(n,t){return t.toUpperCase()});this[t.style[u]=="inherit"?"remove":"apply"](r)}else this.apply(r)}}function inlineFormatWillDelayExecution(n){return n.collapsed&&!RangeUtils.isExpandable(n)}function InlineFormatTool(n){FormatTool.call(this,$.extend(n,{finder:new InlineFormatFinder(n.format),formatter:function(){return new InlineFormatter(n.format)}})),this.willDelayExecution=inlineFormatWillDelayExecution}function FontTool(n){Tool.call(this,n);var t=$.browser.msie?"tSelectBox":"tComboBox",i=[{tags:["span"]}],r=new GreedyInlineFormatFinder(i,n.cssAttr);this.command=function(t){return new FormatCommand($.extend(t,{formatter:function(){var r={};return r[n.domAttr]=t.value,new GreedyInlineFormatter(i,{style:r},n.cssAttr)}}))},this.willDelayExecution=inlineFormatWillDelayExecution,this.update=function(n,i,u){var e=n.data(t),f,o;e.close(),f=u.getPending(this.name),o=f&&f.params?f.params.value:r.getFormat(i),e.value(o)},this.init=function(i,r){var u=r.editor;i[t]({data:u[n.name],onChange:function(t){Tool.exec(u,n.name,t.value)},onItemCreate:function(n){n.html='<span unselectable="on" style="display:block;">'+n.dataItem.Text+"<\/span>"},highlightFirst:!1}),i.data(t).value("inherit")}}function ColorTool(n){Tool.call(this,n);var t=[{tags:inlineElements}];this.update=function(n){n.data("tColorPicker").close()},this.command=function(i){return new FormatCommand($.extend(i,{formatter:function(){var r={};return r[n.domAttr]=i.value,new GreedyInlineFormatter(t,{style:r},n.cssAttr)}}))},this.willDelayExecution=inlineFormatWillDelayExecution,this.init=function(t,i){var r=i.editor;t.tColorPicker({selectedColor:"#000000",onChange:function(t){Tool.exec(r,n.name,t.value)}})}}function StyleTool(){Tool.call(this);var n=[{tags:["span"]}],t=new GreedyInlineFormatFinder(n,"className");this.command=function(t){return new FormatCommand($.extend(t,{formatter:function(){return new GreedyInlineFormatter(n,{className:t.value})}}))},this.update=function(n,i){var r=n.data("tSelectBox");r.close(),r.value(t.getFormat(i))},this.init=function(n,t){var i=t.editor;n.tSelectBox({data:i.style,title:i.localization.style,onItemCreate:function(n){var t=dom.inlineStyle(i.document,"span",{className:n.dataItem.Value});n.html='<span unselectable="on" style="display:block;'+t+'">'+n.html+"<\/span>"},onChange:function(n){Tool.exec(i,"style",n.value)}})}}