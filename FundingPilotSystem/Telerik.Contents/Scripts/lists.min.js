function ListFormatFinder(n){var t=[n=="ul"?"ol":"ul",n];BlockFormatFinder.call(this,[{tags:t}]),this.isFormatted=function(t){for(var r=[],u,i=0;i<t.length;i++)(u=this.findFormat(t[i]))&&dom.name(u)==n&&r.push(u);if(r.length<1||r.length!=t.length)return!1;for(i=0;i<r.length;i++)if(r[i]!=u)return!1;return!0},this.findSuitable=function(i){var r=dom.parentOfType(i[0],t);return r&&dom.name(r)==n?r:null}}function ListFormatter(n,t){function r(n,t){for(var r=dom.create(n.ownerDocument,"li"),i,u=0;u<t.length;u++){if(i=t[u],dom.is(i,"li")){n.appendChild(i);continue}if(dom.is(i,"ul")||dom.is(i,"ol")){while(i.firstChild)n.appendChild(i.firstChild);continue}if(dom.is(i,"td")){while(i.firstChild)r.appendChild(i.firstChild);n.appendChild(r),i.appendChild(n),n=n.cloneNode(!1),r=r.cloneNode(!1);continue}r.appendChild(i),dom.isBlock(i)&&(n.appendChild(r),dom.unwrap(i),r=r.cloneNode(!1))}r.firstChild&&n.appendChild(r)}function u(n,t){for(var i=0;i<t.length;i++)if(isAncestorOrSelf(n,t[i]))return!0;return!1}function f(n,t){if(n.className=="t-marker"){var i=n.nextSibling;if(i&&dom.isBlock(i)||(i=n.previousSibling,i&&dom.isBlock(i)))return!1}return u(n,t)||dom.isInline(n)||n.nodeType==3}function e(n){for(var u=document.createDocumentFragment(),f,i,e,r=n.firstChild;r;r=r.nextSibling){for(i=dom.create(n.ownerDocument,t||"p");r.firstChild;)e=r.firstChild,dom.isBlock(e)?(i.firstChild&&(u.appendChild(i),i=dom.create(n.ownerDocument,t||"p")),u.appendChild(e)):i.appendChild(e);i.firstChild&&u.appendChild(i)}f=$(n).parents("ul,ol"),f[0]?(dom.insertAfter(u,f.last()[0]),f.last().remove()):dom.insertAfter(u,n),dom.remove(n)}var i=new ListFormatFinder(n);this.split=function(n){var t=textNodes(n),e,o,r,s,u,f;if(t.length)for(e=dom.parentOfType(t[0],["li"]),o=dom.parentOfType(t[t.length-1],["li"]),n.setStartBefore(e),n.setEndAfter(o),r=0,s=t.length;r<s;r++)u=i.findFormat(t[r]),u&&(f=$(u).parents("ul,ol"),f[0]?split(n,f.last()[0],!0):split(n,u,!0))},this.apply=function(t){var e=t.length==1?dom.parentOfType(t[0],["ul","ol"]):dom.commonAncestor.apply(null,t),h,u,l,a,c,v,o,s;for(e||(e=dom.parentOfType(t[0],["td"])||t[0].ownerDocument.body),dom.isInline(e)&&(e=dom.blockParentOrBody(e)),h=[],u=i.findSuitable(t),u||(u=new ListFormatFinder(n=="ul"?"ol":"ul").findSuitable(t)),l=dom.significantChildNodes(e),/table|tbody/.test(dom.name(e))&&(l=$.map(t,function(n){return dom.parentOfType(n,["td"])})),a=0;a<l.length;a++)c=l[a],v=dom.name(c),!f(c,t)||u&&isAncestorOrSelf(u,c)||(u&&(v=="ul"||v=="ol")?($.each(c.childNodes,function(){h.push(this)}),dom.remove(c)):h.push(c));for(h.length!=l.length||e==t[0].ownerDocument.body||/table|tbody|tr|td/.test(dom.name(e))||(h=[e]),u||(u=dom.create(e.ownerDocument,n),dom.insertBefore(u,h[0])),r(u,h),dom.is(u,n)||dom.changeTag(u,n),o=u.previousSibling;o&&(o.className=="t-marker"||o.nodeType==3&&dom.isWhitespace(o));)o=o.previousSibling;if(o&&dom.name(o)==n){while(u.firstChild)o.appendChild(u.firstChild);dom.remove(u),u=o}for(s=u.nextSibling;s&&(s.className=="t-marker"||s.nodeType==3&&dom.isWhitespace(s));)s=s.nextSibling;if(s&&dom.name(s)==n){while(u.lastChild)s.insertBefore(u.lastChild,s.firstChild);dom.remove(u)}},this.remove=function(n){for(var r,t=0,u=n.length;t<u;t++)(r=i.findFormat(n[t]))&&e(r)},this.toggle=function(n){var t=textNodes(n),u=n.commonAncestorContainer,r;t.length||(n.selectNodeContents(u),t=textNodes(n),!t.length&&(dom.is(n.startContainer,"li")||dom.parentOfType(n.startContainer,["li"]))&&(r=u.ownerDocument.createTextNode(""),n.startContainer.appendChild(r),t=[r],n.selectNode(r.parentNode))),i.isFormatted(t)?(this.split(n),this.remove(t)):this.apply(t)}}function ListCommand(n){n.formatter=new ListFormatter(n.tag),Command.call(this,n)}function ListTool(n){FormatTool.call(this,$.extend(n,{finder:new ListFormatFinder(n.tag)})),this.command=function(t){return new ListCommand($.extend(t,{tag:n.tag}))}}