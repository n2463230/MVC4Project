function BlockFormatFinder(n){function t(n,t){for(var r,i=0;i<t.length;i++)if(r=t[i],r==null||!isAncestorOrSelf(n,r))return!1;return!0}this.findSuitable=function(i){for(var u=[],f,r=0;r<i.length;r++){if(f=dom.ofType(i[r],n[0].tags)?i[r]:dom.parentOfType(i[r],n[0].tags),!f)return[];$.inArray(f,u)<0&&u.push(f)}for(r=0;r<u.length;r++)if(t(u[r],u))return[u[r]];return u},this.findFormat=function(t){for(var r=0;r<n.length;r++)for(var i=t,u=n[r].tags,f=n[r].attr;i;){if(dom.ofType(i,u)&&attrEquals(i,f))return i;i=i.parentNode}return null},this.getFormat=function(n){var r=$.proxy(function(n){return this.findFormat(isDataNode(n)?n.parentNode:n)},this),i=r(n[0]),t,u;if(!i)return"";for(t=1,u=n.length;t<u;t++)if(i!=r(n[t]))return"";return i.nodeName.toLowerCase()},this.isFormatted=function(n){for(var t=0;t<n.length;t++)if(!this.findFormat(n[t]))return!1;return!0}}function BlockFormatter(n,t){function r(n,t,i){var u=i.length==1?dom.blockParentOrBody(i[0]):dom.commonAncestor.apply(null,i),e,f;dom.isInline(u)&&(u=dom.blockParentOrBody(u));var o=dom.significantChildNodes(u),s=findNodeIndex(o[0]),r=dom.create(u.ownerDocument,n,t);for(e=0;e<o.length;e++){if(f=o[e],dom.isBlock(f)){dom.attr(f,t),r.childNodes.length&&(dom.insertBefore(r,f),r=r.cloneNode(!1)),s=findNodeIndex(f)+1;continue}r.appendChild(f)}r.firstChild&&dom.insertAt(u,r,s)}var i=new BlockFormatFinder(n);this.apply=function(u){var f=dom.is(u[0],"img")?[u[0]]:i.findSuitable(u),o=f.length?formatByName(dom.name(f[0]),n):n[0],h=o.tags[0],s=$.extend({},o.attr,t),e;if(f.length)for(e=0;e<f.length;e++)dom.attr(f[e],s);else r(h,s,u)},this.remove=function(t){for(var r,u=0,f=t.length;u<f;u++)r=i.findFormat(t[u]),r&&(dom.ofType(r,["p","img","li"])?dom.unstyle(r,formatByName(dom.name(r),n).attr.style):dom.unwrap(r))},this.toggle=function(n){var t=RangeUtils.nodes(n);i.isFormatted(t)?this.remove(t):this.apply(t)}}function GreedyBlockFormatter(n,t){var i=new BlockFormatFinder(n);this.apply=function(i){var u=blockParents(i),f=n[0].tags[0],r,e;if(u.length)for(r=0,e=u.length;r<e;r++)if(dom.is(u[r],"li")){var s=u[r].parentNode,h=new ListFormatter(s.nodeName.toLowerCase(),f),o=this.editor.createRange();o.selectNode(u[r]),h.toggle(o)}else dom.changeTag(u[r],f);else new BlockFormatter(n,t).apply(i)},this.toggle=function(n){var t=textNodes(n);t.length||(n.selectNodeContents(n.commonAncestorContainer),t=textNodes(n),t.length||(t=dom.significantChildNodes(n.commonAncestorContainer))),this.apply(t)}}function FormatCommand(n){n.formatter=n.formatter(),Command.call(this,n)}function BlockFormatTool(n){FormatTool.call(this,$.extend(n,{finder:new BlockFormatFinder(n.format),formatter:function(){return new BlockFormatter(n.format)}}))}function FormatBlockTool(){Tool.call(this);var n=new BlockFormatFinder([{tags:blockElements}]);this.command=function(n){return new FormatCommand($.extend(n,{formatter:function(){return new GreedyBlockFormatter([{tags:[n.value]}],{})}}))},this.update=function(t,i){var r=t.data("tSelectBox");r.close(),r.value(n.getFormat(i))},this.init=function(n,t){var i=t.editor;n.tSelectBox({data:i.formatBlock,title:i.localization.formatBlock,onItemCreate:function(n){var t=n.dataItem.Value;n.html="<"+t+' unselectable="on" style="margin: .3em 0;'+dom.inlineStyle(i.document,t)+'">'+n.dataItem.Text+"<\/"+t+">"},onChange:function(n){Tool.exec(i,"formatBlock",n.value)},highlightFirst:!1})}}