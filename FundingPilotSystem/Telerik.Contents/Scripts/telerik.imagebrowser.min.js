(function(n,t){function s(n,t,i,r){var u=t?'<div class="t-widget t-upload"><div class="t-button t-button-icontext t-button-bare t-upload-button"><span class="t-icon t-add"><\/span>'+n.uploadFile+'<input type="file" name="file" /><\/div><\/div>':"",f=i?'<button type="button" class="t-button t-button-icon t-button-bare"><span class="t-icon t-addfolder"><\/span><\/button>':"",e=r?'<button type="button" class="t-button t-button-icon t-button-bare t-state-disabled"><span class="t-icon t-delete"><\/span><\/button>&nbsp;':"";return'<div class="t-widget t-toolbar t-floatwrap"><div class="t-toolbar-wrap">'+u+f+e+'<\/div><div class="t-tiles-arrange">'+n.orderBy+' <a href="#" class="t-link"><span>'+n.orderByName+'<\/span><span class="t-icon t-arrow-down"><\/span><\/a><\/div><\/div>'}function h(n){return'<li class="t-tile" data-filename="'+n.name+'"><div class="t-thumb"><span class="t-icon t-loading"><\/span><\/div><strong>'+n.name+"<\/strong><\/li>"}function c(n){return'<li class="t-tile-empty"><strong>'+n+"<\/strong><\/li>"}function u(n){return'<li class="t-tile" data-filename="'+n.name+'" data-thumburl="'+n.thumbUrl+'" data-url="'+n.url+'" data-kind="'+n.kind+'"><div class="t-thumb"><span class="t-icon t-loading"><\/span><\/div><strong>'+n.name+'<\/strong><span class="t-filesize">'+n.size+"<\/span>"}function o(n){return'<li class="t-tile" data-url="'+n.url+'" data-kind="'+n.kind+'"><div class="t-thumb"><span class="t-icon t-folder"><\/span><\/div><strong>'+n.name+"<\/strong><\/li>"}function l(n){return'<li class="t-tile" data-kind="d"><div class="t-thumb"><span class="t-icon t-folder"><\/span><\/div><input class="t-input" value="'+n+'" /><\/li>'}function f(t){var i=n(t),r=n("<img />",{alt:i.data("filename")}).hide().bind("load",function(){n(this).prev().remove().end().addClass("t-image").fadeIn()});i.find(".t-loading").after(r),r.attr("src",i.data("thumburl")),t.loaded=!0}function p(n){return new RegExp(n.replace(a,"\\$1").replace(v,".*").replace(y,".?"),"ig")}var i=n.telerik,r=n.telerik.query,e;i.scripts.push("telerik.imagebrowser.js"),i.imageBrowser=function(t,r){var c,e,o,a,h;this.element=t,this.wrapper=n(t),c=r.filter||"*.png,*.gif,*.jpg,*.jpeg",e=r.localization,this.wrapper.append('<div class="t-floatwrap"><div class="t-widget t-combobox t-header t-breadcrumbs"><div class="t-dropdown-wrap t-state-default"><input type="text" class="t-input" /><div class="t-breadcrumbs-wrap"/><span class="t-select t-header"><span class="t-icon t-arrow-down">select<\/span><\/span><\/div><\/div><div class="t-widget t-combobox t-dropdown-wrap t-search-wrap" /><\/div>').append(s(e,r.uploadUrl,r.createDirectoryUrl,r.deleteFileUrl||r.deleteDirectoryUrl)).append('<ul id="t-editor-image-list" class="t-reset t-floats t-tiles" />');var f=this.wrapper.find(".t-breadcrumbs"),u=this.wrapper.find(".t-tiles"),l=this.wrapper.find(".t-search-wrap");r.uploadUrl&&this.wrapper.find(".t-upload input").tUpload({async:{saveUrl:r.uploadUrl,autoUpload:!0},multiple:!1,onUpload:function(n){var r=new RegExp(("("+c.split(",").join(")|(")+")").replace(/\*\./g,".*."),"i"),t=n.files[0].name;r.test(t)?(n.data={path:f.val()},u.trigger("t:upload",[{name:t},function(){n.preventDefault()}])):(n.preventDefault(),alert(i.formatString(e.invalidFileType,t,c)))},onError:function(n){n.preventDefault(),u.trigger("t:error",[n.files[0]]);var t=n.XMLHttpRequest;i.ajaxError(r.element,"error",t,t.statusText)},onSuccess:function(t){u.trigger("t:completeFile",[n.extend(t.response,{path:f.val()})])}}),new i.searchBox(l[0]),new i.fileListView(u[0],{thumbnailUrl:r.thumbUrl,localization:e}),o=new i.dropDown({effects:i.fx.slide.defaults(),onClick:function(i){n(t).find(".t-tiles-arrange a span:first").html(n(i.item).text()),o.close(),f.trigger("t:change")}}),a=[{Text:e.orderByName,Value:"name"},{Text:e.orderBySize,Value:"size"}],o.dataBind(a),this.wrapper.find(".t-tiles-arrange a").click(function(t){t.preventDefault();var r=n(this);o.open({offset:r.offset(),outerHeight:r.outerHeight(),outerWidth:r.outerWidth(),zIndex:i.getElementZIndex(this)})}).end().delegate(".t-button:not(.t-state-disabled):has(.t-delete)","click",function(){var f=u.find(".t-state-selected");f.length&&confirm(i.formatString(e.deleteFile,f.find("strong").text()))&&n.ajax({type:"POST",url:f.data("kind")=="f"?r.deleteFileUrl:r.deleteDirectoryUrl,data:{path:f.data("url")},error:function(n,t){i.ajaxError(r.element,"error",n,t)},success:function(){u.trigger("t:delete"),n(t).find(".t-delete").parent().addClass("t-state-disabled")}})}).delegate(".t-button:not(.t-state-disabled):has(.t-addfolder)","click",function(){u.trigger("t:createDirectory",[function(t){n.ajax({type:"POST",url:r.createDirectoryUrl,data:{path:f.val(),name:t},error:function(n,f){u.trigger("t:errorDirectory",{name:t}),i.ajaxError(r.element,"error",n,f)},success:function(){u.trigger("t:completeDirectory",{path:f.val(),name:t})}})}])}),n(document.documentElement).bind("mousedown",function(t){var i=o.$element[0];n.contains(i,t.target)||o.close()}),h=new i.dataSource({error:function(n,t){var u=i.trigger(r.element,"error",{XMLHttpRequest:n,textStatus:t});u||(t=="error"?n.status=="404"?alert(r.localization.directoryNotFound):n.status!="0"&&alert("Error! The requested URL returned "+n.status+" - "+n.statusText):t=="timeout"&&alert("Error! Server timeout."))},url:r.selectUrl,callback:function(r){n(t).find(".t-delete").parent().addClass("t-state-disabled"),f.val()||new i.breadcrumbs(f[0],{path:r.Path,roots:r.ContentPaths}),f.val(r.Path).trigger("t:refresh");var e=n(t).find(".t-tiles-arrange a span:first").text(),o=n.map(a,function(n){if(n.Text==e)return n.Value})[0],s=l.val();u.trigger("t:refresh",[r,o,s])}}),l.bind("t:change",function(){f.trigger("t:change")}),h.get({path:""}),u.bind("t:select",function(n){n.kind=="d"?h.get({path:n.url}):r.apply(n)}).bind("t:change",function(i){var f=n(t).find(".t-delete").parent().addClass("t-state-disabled"),u;i.kind=="f"&&(u=i.url,r.imageUrl&&(u=r.imageUrl+"?path="+u),n(t).parent().find("#t-editor-image-url").val(u)),(i.kind=="f"&&r.deleteFileUrl||i.kind=="d"&&r.deleteDirectoryUrl)&&f.removeClass("t-state-disabled")}),f.bind("t:change",function(){var t=n(this).val();t.match(/\/$/)||(t=t+"/"),h.get({path:t})})},i.fileInfoReader=function(n){this._thumbnailUrl=n.thumbnailUrl||""},i.fileInfoReader.prototype={read:function(n,t){return t[n]||t[n.charAt(0).toUpperCase()+n.substring(1)]},directories:function(n){return this.read("directories",n)},files:function(n){return this.read("files",n)},thumbUrl:function(n,t){return this._thumbnailUrl+"/?path="+n+encodeURIComponent(t)},size:function(n){var t=this.read("size",n),i;return t?(i=" bytes",t>=1073741824?(i=" GB",t/=1073741824):t>=1048576?(i=" MB",t/=1048576):t>=1024&&(i=" KB",t/=1024),Math.round(t*100)/100+i):""},name:function(n){return this.read("name",n)},path:function(n){return this.read("path",n)},concatPaths:function(n,i){return n!==t&&n.match(/\/$/)||(n=(n||"")+"/"),n+encodeURIComponent(i)}},i.fileListView=function(t,r){this.element=t,this.wrapper=n(t),this._localization=r.localization,this._reader=r.reader||new i.fileInfoReader({thumbnailUrl:r.thumbnailUrl}),this._pageSize=r.pageSize||20,this.wrapper.bind({"t:refresh":n.proxy(this._refresh,this),"t:upload":n.proxy(this._upload,this),"t:completeDirectory":n.proxy(this._completeDirectory,this),"t:delete":n.proxy(this._delete,this),"t:errorFile":n.proxy(this._errorFile,this),"t:errorDirectory":n.proxy(this._errorDirectory,this),"t:createDirectory":n.proxy(this._createDirectory,this),scroll:n.proxy(this._scroll,this)}).delegate("li[data-url]:not(.t-tile-empty)","click",n.proxy(this._click,this)).delegate("li[data-url]:not(.t-tile-empty)","dblclick",n.proxy(this._dblclick,this))},e=n.browser.msie&&parseFloat(n.browser.version)<8?function(n){return n.offsetTop}:function(t){return t.offsetTop-n(t).height()};var a=/(\:|\^|\$|\/|\.|\+|\||\(|\)|\[|\]|\{|\}|\\)/g,v=/\*/g,y=/\?/g;i.fileListView.prototype={bindTo:function(n,t,i){var s,f,e,h,c,l;this._filter=i,s=this._reader,this.wrapper.empty(),f=r(this._reader.directories(n)||[]),e=r(this._reader.files(n)||[]),i&&(h=function(n){return p(i).test(s.name(n))},f=f.where(h),e=e.where(h)),c=function(n){return s[t](n)},this._data=this._process(this._reader.path(n),f.orderBy(c),e.orderBy(c)),l=this._data.select(function(n){return n.kind=="f"?u(n):o(n)}).toArray().join(""),this.wrapper.append(l),this._tiles=this.wrapper.find("li[data-kind=f]"),this._scroll(),this._asEmpty()},_asEmpty:function(){this._data.any()||this._filter||this.wrapper.append(c(this._localization.emptyFolder))},_completeFile:function(t,i){var r=this._reader.name(t),o=this._reader.path(t),e=n(u({kind:"f",thumbUrl:this._reader.thumbUrl(o,r),url:this._reader.concatPaths(o,r),name:r,size:this._reader.size(t)}));this.wrapper.find("li").eq(this.fileIndex(i)).replaceWith(e),f(e[0]),e.click()},_completeDirectory:function(t,i){var r=this._reader.name(i),u=this._reader.path(i),f=n(o({kind:"d",url:this._reader.concatPaths(u,r),name:r}));this.wrapper.find("li").eq(this.directoryIndex(r)).replaceWith(f)},_delete:function(){var n=this.wrapper.find(".t-state-selected"),t;n.length&&(t=this._data.toArray(),t.splice(n.index(),1),this._data=r(t),n.remove(),this._scroll(),this._asEmpty())},_scroll:function(){clearTimeout(this._timeout),this._timeout=setTimeout(n.proxy(function(){var i=this.wrapper.outerHeight(),n=this.wrapper.scrollTop(),t=n+i;this._tiles.each(function(){var i=e(this),r=i+this.offsetHeight;return(i>=n&&i<t||r>=n&&r<t)&&f(this),i>t?!1:void 0}),this._tiles=this._tiles.filter(function(){return!this.loaded})},this),250)},_upload:function(t,r,u){var e=r.name,o=this.fileIndex(e),f,s,c;if(o>-1&&!confirm(i.formatString(this._localization.overwriteFile,e)))u();else{this.wrapper.find(".t-tile-empty").remove(),f=n(h(r)),o>-1?(f.data("existing",!0),this.wrapper.find("li").eq(o).replaceWith(f)):(s=this.wrapper.find("li[data-kind=f]:first"),s.length?s.before(f):this.wrapper.append(f),c=this._data.toArray(),c.splice(f.index(),0,{name:e,kind:"f"})),this.wrapper.scrollTop(f.attr("offsetTop")-this.element.offsetHeight);this.wrapper.one("t:completeFile",n.proxy(function(n,t){this._completeFile(t,e)},this))}},_nameDirectory:function(){var t="New folder",u=this._data.where(function(n){return n.kind=="d"&&n.name.indexOf(t)>-1}).select(function(n){return n.name}).toArray(),i,r;if(n.inArray(t,u)>-1){i=2;do r=t+" ("+i+")",i++;while(n.inArray(r,u)>-1);t=r}return t},_createDirectory:function(t,i){var o=this._nameDirectory(),r=n(l(o)),u=this.wrapper.find("li[data-kind=f]:first"),f,e;u.length?u.before(r):this.wrapper.append(r),f=this._data.toArray(),e=r.addClass("t-state-selected").siblings().removeClass("t-state-selected").end().find("input").keydown(function(n){n.keyCode==13&&this.blur()}).blur(n.proxy(function(t){var u=n.trim(t.target.value);(!u||this._data.any(function(n){return n.kind=="d"&&n.name.toLowerCase()==u.toLowerCase()}))&&(u=this._nameDirectory()),f.splice(r.index(),0,{name:u,kind:"d"}),n(t.target).replaceWith("<strong>"+u+"<\/strong>"),i(u)},this)),setTimeout(function(){e.select()}),this.wrapper.find(".t-tile-empty").remove(),this.wrapper.scrollTop(r.attr("offsetTop")-this.element.offsetHeight)},_errorFile:function(t,i){var r=this.fileIndex(i.name),e,o;r>-1&&(e=this.wrapper.find("li").eq(r),e.data("existing")?(o=n(u(this._data.toArray()[r])),e.replaceWith(o),f(o[0])):(e.remove(),this._data.toArray().splice(r,1)),this._asEmpty())},_errorDirectory:function(n,t){var i=this.directoryIndex(t.name);i>-1&&(this.wrapper.find("li").eq(i).remove(),this._data.toArray().splice(i,1),this._asEmpty())},fileIndex:function(n){return this._index("f",n)},directoryIndex:function(n){return this._index("d",n)},_index:function(t,i){var r=-1,u=this._data?this._data.toArray():[];return i=i.toLowerCase(),n.each(u,function(n,u){if(u.kind==t&&u.name.toLowerCase()==i)return r=n,!1}),r},_raise:function(t,r){var u=n(t.currentTarget);i.trigger(this.wrapper,r,{kind:u.data("kind"),url:u.data("url")})},_click:function(t){n(t.currentTarget).addClass("t-state-selected").siblings().removeClass("t-state-selected"),this._raise(t,"t:change")},_dblclick:function(n){document.selection&&document.selection.empty&&document.selection.empty(),this._raise(n,"t:select")},_refresh:function(n,t,i,r){this.bindTo(t,i,r)},_process:function(n,t,i){var r=this._reader,t=t.select(function(t){return{url:r.concatPaths(n,r.name(t)),name:r.name(t),kind:"d"}}),i=i.select(function(t){var i=r.name(t);return{url:r.concatPaths(n,i),name:i,kind:"f",thumbUrl:r.thumbUrl(n,i),size:r.size(t)}});return t.concat(i)}},i.dataSource=function(n){this._url=n.url,this._callback=n.callback,this._error=n.error},i.dataSource.prototype={_complete:function(n){this._callback&&this._callback(n)},get:function(t){n.ajax({type:"POST",url:this._url,data:t,success:n.proxy(this._complete,this),error:this._error})}},i.breadcrumbs=function(t,r){this.element=t,this.wrapper=n(t),this._gap=r.gap||50,this._initPaths(r.path);var u=new i.dropDown({effects:i.fx.slide.defaults(),onClick:n.proxy(function(i){var r=n(i.item).text();u.close(),this._initPaths(r),n(t).val(r).trigger("t:change")},this)});u.dataBind(r.roots),this.wrapper.delegate("input","focus",n.proxy(this._focus,this)).delegate("input","blur",n.proxy(this._blur,this)).delegate("input","keydown",n.proxy(function(n){n.keyCode==13&&this._blur()},this)).delegate("a:not(.t-first)","click",i.stopAll(this._click,this)).delegate(".t-select","click",function(){var r=n(t);u.open({offset:r.offset(),outerHeight:r.outerHeight(),outerWidth:r.outerWidth(),zIndex:i.getElementZIndex(this)})}).bind("t:refresh",n.proxy(this.refresh,this)),n(document.documentElement).bind("mousedown",function(t){var i=u.$element[0];n.contains(i,t.target)||u.close()}),this.value(r.path)},i.breadcrumbs.prototype={_initPaths:function(n){this._basePath=(n||"").replace(/\/{2,}/g,"/").replace(/\/$/,""),n=this._basePath.split("/"),n.pop(),this._root=n.join("/")},_html:function(){var r=this._basePath.split("/").length-1,i=this.value();return i!==t&&i.match(/^\//)||(i="/"+(i||"")),'<div class="t-dropdown-wrap t-state-default"><input type="text" class="t-input" /><div class="t-breadcrumbs-wrap">'+n.map(i.split("/"),function(n,t){if(n&&t>=r)return'<a class="t-link" href="#">'+n+"<\/a>"}).join('<span class="t-icon t-arrow-next">&gt;<\/span>')+'<\/div><span class="t-select t-header"><span class="t-icon t-arrow-down">select<\/span><\/span><\/div>'},_path:function(t){return this._root+"/"+n.map(t,function(t){return n(t).text()}).join("/")},_update:function(n){n=n.charAt(0)==="/"?n:"/"+n;var t=this.value()!=n;this.value(n),t&&this.wrapper.trigger("t:change")},value:function(n){if(n!==t)this.wrapper.val(n.replace(/\/{2,}/g,"/")),this.refresh();else return this.wrapper.val()},_click:function(t){this._update(this._path(n(t.target).prevAll("a").andSelf()))},refresh:function(){this.wrapper.empty().append(this._html());var t=this.wrapper.width()-this._gap,i=this.wrapper.find("a");i.each(function(r){var u=n(this);u.parent().width()>t&&(r==i.length-1?u.width(t):u.prev().andSelf().hide())})},_focus:function(){var n=this.wrapper.find(".t-breadcrumbs-wrap").hide().end().find("input").val(this.value());setTimeout(function(){n.select()})},_blur:function(){var n=this.wrapper.find("input").val().replace(/\/{2,}/g,"/");(!n||n.toLowerCase().indexOf(this._basePath.toLowerCase())<0)&&(n=this._basePath),this._update(n)}},i.searchBox=function(t){this.element=t,this.wrapper=n(t),this.wrapper.delegate("input","focus",n.proxy(this._focus,this)).delegate("input","blur",n.proxy(this._blur,this)).delegate("input","keydown",n.proxy(function(n){n.keyCode==13&&this._blur()},this)).delegate("a","click",i.stopAll(this._click,this)),this._render()},i.searchBox.prototype={_render:function(){this.wrapper.empty().append(n('<label for="t-imagebrowser-search">Search<\/label><input type="text" id="t-imagebrowser-search" class="t-input" /><a href="#" class="t-icon t-search">search<\/a>'))},_focus:function(){this.wrapper.find("label").hide()},_blur:function(){this._update(this.wrapper.find("input").val()),this.value()==""&&this.wrapper.find("label").show()},_update:function(n){var t=this.value()!=n;this.value(n),t&&this.wrapper.trigger("t:change")},value:function(n){if(n!==t)this.wrapper.val(n);else return this.wrapper.val()},_click:function(){this._blur()}}})(jQuery);